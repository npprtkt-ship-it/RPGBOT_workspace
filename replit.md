# イニシエダンジョン (Initiation Dungeon)

## プロジェクト概要
Discord RPG Bot - 100階層のダンジョン探索ゲーム

### ゲームの特徴
- **100階層ダンジョン**: 10,000mを100mごとに区切った100階層構造
- **ループシステム**: 死亡時にループし、アップグレードポイントで強化
- **ストーリー**: 距離・ループ回数に応じた分岐ストーリー
- **戦闘システム**: 通常敵・ボス戦（1000m毎）
- **装備・インベントリ**: 武器・防具の収集と装備システム
- **称号システム**: 死亡パターンに応じた称号獲得
- **倉庫システム**: 次回プレイに持ち越せるアイテム保管

## 技術スタック
- **言語**: Python 3.11
- **フレームワーク**: discord.py 2.6.4
- **データベース**: Supabase (REST API経由、httpx使用)
- **非同期処理**: asyncio + asyncio.Lock (競合状態防止)

## 環境変数
必要なシークレット（Replitの環境変数に設定済み）:
- `DISCORD_BOT_TOKEN`: Discord Bot Token
- `SUPABASE_URL`: Supabase Project URL
- `SUPABASE_KEY`: Supabase API Key
- `SESSION_SECRET`: セッション管理用シークレット

## プロジェクト構造

### コアファイル
- `main.py`: Botメインエントリーポイント、コマンド定義
- `db.py`: Supabase REST API操作
- `game.py`: ゲームロジック（敵生成、装備、アイテム）
- `views.py`: Discord UI Views（ボタン、モーダル、戦闘画面）
- `story.py`: ストーリーシステム（6472行の大規模ストーリーデータ）
- `death_system.py`: 死亡・ループシステム
- `titles.py`: 称号システム
- `config.py`: 設定ファイル
- `debug_commands.py`: デバッグコマンド

### データベーススキーマ
- `supabase_schema.sql`: Supabaseテーブル定義
  - `players`: プレイヤー情報
  - `storage`: 倉庫アイテム
  - `death_history`: 死亡履歴
  - `player_titles`: 獲得称号
  - `secret_weapons_global`: シークレット武器統計

## 主要機能

### コマンド
- `!start`: ゲーム開始、専用チャンネル作成
- `!move`: ダンジョン探索（5-15m進む）
- `!inventory`: インベントリ確認
- `!status`: ステータス確認
- `!upgrade`: アップグレードメニュー
- `!reset`: データリセット（2段階確認）

### ゲームメカニクス
- **距離ベースイベント**:
  - 250m毎: ストーリーイベント
  - 500m毎: 特殊イベント
  - 1000m毎: ボス戦
- **イベント確率**:
  - 60%: 何もなし
  - 30%: 敵遭遇
  - 9%: 宝箱
  - 1%: トラップ宝箱
  - 0.1%: 選択肢ストーリー
  - 0.1%: シークレット武器

### 競合制御
- `user_processing` dict: 重複処理防止
- `user_locks` dict: `asyncio.Lock()`でユーザー別ロック
- 戦闘・宝箱処理でロック使用（ボタン連打バグ修正済み）

## デプロイメント

### 重要: Koyeb推奨
このDiscord Botは24/7稼働が必要なため、**Koyeb**へのデプロイを推奨します。
Replitでの24/7稼働はDiscord Bot ToSに抵触する可能性があるため、開発・テスト専用として使用してください。

### Koyebデプロイ手順
1. Koyebアカウント作成
2. 環境変数設定（DISCORD_BOT_TOKEN, SUPABASE_URL, SUPABASE_KEY）
3. `python main.py` で起動
4. ヘルスチェック: ポート8000で稼働

## 開発状況

### 実装済み機能
- ✅ 基本ゲームシステム（探索、戦闘、装備）
- ✅ ストーリーシステム（距離・ループ依存）
- ✅ 死亡・ループメカニクス
- ✅ アップグレードシステム
- ✅ 称号・実績システム
- ✅ 倉庫システム
- ✅ ボス戦（1000m毎、10000mラスボス）
- ✅ シークレット武器システム
- ✅ 競合制御（asyncio.Lock）
- ✅ **デバッグコマンドシステム**（管理者・ユーザー向け）

### 修正済みバグ
- ✅ 戦闘ボタン連打による重複アイテムドロップ
- ✅ HP≤3時のフリーズ問題
- ✅ エスケープ失敗時の死亡処理
- ✅ **2025-10-29**: BattleViewのプレイヤーデータ同期問題
  - fightボタン内でプレイヤーデータ最新化
  - defendボタン内でプレイヤーデータ最新化
  - runボタン内でプレイヤーデータ最新化
  - use_skillボタン内でプレイヤーデータ最新化
  - item_select_callback内でプレイヤーデータ再取得＆所持確認
  - 全ボタンにデバッグログ追加（HP/MP/インベントリ状態の可視化）
- ✅ **2025-10-30**: 4つの重大バグ修正
  - **バグ1**: ボス戦開始時HP-1問題
    - BossBattleView/FinalBossBattleViewの`_async_init()`でプレイヤーデータ最新化
    - 非同期処理中のデータ同期問題を解決
  - **バグ2**: 戦闘中Embed固まり問題
    - BattleViewの全ボタンコールバック（fight, defend, run, use_skill）にfinally句を追加
    - エラー発生時も確実にuser_processingをクリア
    - on_timeout()でもuser_processingをクリア
  - **バグ3**: 宝箱インタラクションエラー
    - 確認の結果、TreasureViewは既にdefer()を適切に使用しており修正不要
  - **バグ4**: 500mイベントインタラクションエラー
    - SpecialEventViewの全ボタン（鍛冶屋、行商人、ストーリー）にdefer()を追加
    - edit_original_response()を使用してDiscordの3秒インタラクション制限に対応
- ✅ **2025-11-01**: 行商人イベントシステム改善
  - MaterialMerchantView（素材買取のみ）を削除
  - merchant_system.pyのMerchantViewを使用するように変更
  - 行商人イベントで以下の機能が利用可能に：
    - アイテム購入（武器、防具、ポーション）
    - アイテム売却（すべてのアイテム、売却価格50%）
    - ステータス確認

## デバッグコマンドシステム（2025-10-31実装）

### 管理者専用コマンド
**対象ユーザーID**: 1301416493401243694, 785051117323026463

1. **`!admin_stats`** - システム統計表示
   - 総プレイヤー数、アクティブプレイヤー、エラーログ数
   - 最遠到達プレイヤー情報

2. **`!admin_logs [件数]`** - 最近のエラーログ表示（デフォルト10件）
   - Koyebデプロイ時のエラー監視に使用
   - タイムスタンプ、エラータイプ、ユーザーID付き

3. **`!admin_clear_logs`** - エラーログをクリア

4. **`!admin_ban <user_id>`** - ユーザーをBAN

5. **`!admin_unban <user_id>`** - BANを解除

6. **`!admin_player <user_id>`** - プレイヤー情報表示
   - HP、距離、ゴールド、死亡回数、BAN状態

7. **`!admin_clear_processing <user_id>`** - **Embed固まり対策**
   - user_processingフラグを強制クリア
   - 戦闘中にEmbedが固まった場合に使用

8. **`!admin_force_reset <user_id>`** - プレイヤーデータ強制削除

### ユーザー向けコマンド

1. **`!rollback`** - 最後のアクションを取り消し
   - スナップショットシステムを使用（直前1アクションのみ）
   - プレイヤーデータを前の状態に復元
   - 使用例：誤って重要なアイテムを売却した場合など

2. **`!debug_status`** - 自分のデバッグ情報表示
   - 処理状態（処理中/待機中）
   - 最後のスナップショット情報
   - 最近のエラー数と詳細

### エラーログマネージャー
- 最大100件のエラーを自動記録
- エラータイプ、メッセージ、ユーザーID、コンテキスト付き
- Koyeb本番環境でのエラー追跡に最適

### スナップショットシステム
- ユーザーごとに最大5個のアクションを保持
- `!move`, 戦闘、装備変更などの重要アクションを自動記録
- ロールバック時に前の状態を完全復元

## 最終更新
- **日付**: 2025-10-31
- **状態**: ✅ デバッグシステム実装完了、Koyeb本番環境で運用中
- **Bot名**: RPG BOT#3992
- **最新追加**: 管理者コマンド、ユーザーロールバック、エラー監視システム

## 注意事項
- 本環境はテスト・開発用です
- 本番環境はKoyebにデプロイしてください
- Supabaseデータベースは共有されています（環境変数で管理）
